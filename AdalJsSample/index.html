<!DOCTYPE html>
<html>
    <head>
        <title>VSTS Autentication ADAL.JS Sample</title>
        <meta charset="utf-8" />
        <style type="text/css">body { font-family: Tahoma; padding: 3em; }</style>
        <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.11/js/adal.min.js"></script>
    </head>
    <body>
        <p>
            VSTS Authentication - ADAL.JS Sample
        </p>
        <p>
            <a href="#" onclick="authContext.login(); return false;">Log in</a> |
            <a href="#" onclick="authContext.logOut(); return false;">Log out</a>
        </p>
        <p id="username"></p>
        <pre id="api_response"></pre>

        <script type="text/javascript">
            // Set up ADAL
            var authContext = new AuthenticationContext({
                clientId: '57c5c51c-2036-433a-befa-ebefc7f10689',//Update with your app regirstion's Application ID
                postLogoutRedirectUri: 'http://localhost:8080' //Where you return upon signout
            });
            // Make an AJAX request to the VSTS REST API and print the response as JSON.
            var getCurrentUser = function (access_token) {
                document.getElementById('api_response').textContent = 'Calling API...';
                var xhr = new XMLHttpRequest();
                xhr.open('GET', 'https://app.vssps.visualstudio.com/_apis/profile/profiles/me?api-version=1.0', true); //API called with ADAL token
                xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        // Parse Successful Response
                        document.getElementById('api_response').textContent =
                            JSON.stringify(JSON.parse(xhr.responseText), null, '  ');
                    } else {
                        // Handle Error
                        document.getElementById('api_response').textContent =
                            'ERROR:\n\n' + xhr.responseText;
                    }
                };
                xhr.send();
            }
            if (authContext.isCallback(window.location.hash)) {
                // Handle redirect after token requests
                authContext.handleWindowCallback();
                var err = authContext.getLoginError();
                if (err) {
                    // TODO: Handle errors signing in and getting tokens
                    document.getElementById('api_response').textContent =
                        'ERROR:\n\n' + err;
                }
            } else {
                // If logged in, get access token and make an API request
                var user = authContext.getCachedUser();
                if (user) {
                    document.getElementById('username').textContent = 'Signed in as: ' + user.userName;
                    document.getElementById('api_response').textContent = 'Getting access token...';
                    
                    // Get an access token to the Microsoft Graph API
                    authContext.acquireToken(
                        '499b84ac-1321-427f-aa17-267ca6975798',
                        function (error, token) {
                            if (error || !token) {
                                // TODO: Handle error obtaining access token
                                document.getElementById('api_response').textContent =
                                    'ERROR:\n\n' + error;
                                return;
                            }
                            // Use the access token
                            getCurrentUser(token);
                        }
                    );
                } else {
                    document.getElementById('username').textContent = 'Not signed in.';
                }
            }
        </script>
    </body>
</html>